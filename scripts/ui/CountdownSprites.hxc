import funkin.play.PlayState;
import funkin.play.Countdown;
import funkin.modding.module.Module;
import funkin.Paths;
import funkin.graphics.adobeanimate.FlxAtlasSprite;
import funkin.modding.base.ScriptedFlxAtlasSprite;
import funkin.play.notes.notestyle.NoteStyle;
import funkin.data.notestyle.NoteStyleRegistry;
import funkin.Conductor;
import flixel.util.FlxTimer;
import flixel.FlxG;


class CountdownSprites extends Module 
{
	
	var styleMatch:bool = false;
	var goSprite:ScriptedFlxAtlasSprite;
	var readySprite:ScriptedFlxAtlasSprite;
	var setSprite:ScriptedFlxAtlasSprite;
 	var noteStyleId:String;
	var noteStyle:NoteStyle;

	function new ()
	{
	        super("CountdownSprites");
	}

	public function onCountdownStart(event:CountdownScriptEvent) 
	{
		super.onCountdownStart(event);

		noteStyleId = PlayState.instance.currentChart.noteStyle;
		noteStyle = NoteStyleRegistry.instance.fetchEntry(noteStyleId);

		if (noteStyleId == 'funkin')
		{
			styleMatch = true;
			readySprite = ScriptedFlxAtlasSprite.init('CountdownSprite', FlxG.width/2, FlxG.height/2, 'READY');
			setSprite = ScriptedFlxAtlasSprite.init('CountdownSprite', FlxG.width/2, FlxG.height/2, 'SET');
			goSprite = ScriptedFlxAtlasSprite.init('CountdownSprite', FlxG.width/2, FlxG.height/2, 'GO');
		}
	}

	public function onCountdownStep(event:CountdownScriptEvent)
	{
		super.onCountdownStep(event);
		if (styleMatch == true)
		switch(event.step)
		{
			case 'GO':
				PlayState.instance.currentStage.add(goSprite);
				goSprite.cameras = [PlayState.instance.camCutscene];
				goSprite.scriptCall('playCutscene');

			case 'ONE':
				PlayState.instance.currentStage.add(setSprite);
				setSprite.cameras = [PlayState.instance.camCutscene];
				setSprite.scriptCall('playCutscene');

			case 'TWO':
				PlayState.instance.currentStage.add(readySprite);
				readySprite.cameras = [PlayState.instance.camCutscene];
				readySprite.scriptCall('playCutscene');
		}	
	}

	public function onCountdownEnd(event:CountdownScriptEvent)
	{
		super.onCountdownEnd(event);
		if (styleMatch == true)
		{
			new FlxTimer().start((((Conductor.instance.beatLengthMs / 1000) * 1)), function(tmr:FlxTimer)
			{
				readySprite.kill();
				setSprite.kill();
				goSprite.kill();
			});
		}
	}	
}